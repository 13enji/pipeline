name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write  # Required to push station sync commits

jobs:
  # Sync stations from Railway before testing (only on push to main)
  # This prevents losing discovered stations when deploying
  sync-stations:
    runs-on: ubuntu-latest
    # Only run on push to main, not PRs, and not if triggered by bot (prevents infinite loop)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && github.actor != 'github-actions[bot]'
    outputs:
      stations_changed: ${{ steps.sync.outputs.changed }}

    steps:
      - uses: actions/checkout@v4
        with:
          # Fetch with token that can push
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync stations from Railway
        id: sync
        run: |
          # Fetch current station list from Railway
          echo "Fetching stations from Railway..."
          RAILWAY_STATIONS=$(curl -s "${{ secrets.APP_URL }}/cache-stats" | jq '[.stations[] | {
            station_id,
            timezone_name,
            name,
            state,
            latitude,
            longitude
          }]' 2>/dev/null || echo "[]")

          # If fetch failed or empty, skip sync
          if [ "$RAILWAY_STATIONS" = "[]" ] || [ -z "$RAILWAY_STATIONS" ]; then
            echo "No stations from Railway or fetch failed, skipping sync"
            echo "changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Railway has $(echo "$RAILWAY_STATIONS" | jq 'length') stations"

          # Load existing stations from git
          GIT_STATIONS=$(cat data/known_stations.json)
          echo "Git has $(echo "$GIT_STATIONS" | jq 'length') stations"

          # Merge: union of both lists, deduplicated by station_id
          # This ensures we never lose stations from either source
          MERGED=$(jq -s '
            (.[0] + .[1]) |
            group_by(.station_id) |
            map(.[0])
          ' <(echo "$GIT_STATIONS") <(echo "$RAILWAY_STATIONS"))

          echo "Merged total: $(echo "$MERGED" | jq 'length') stations"

          # Check if merged is different from git
          if [ "$(echo "$MERGED" | jq -S '.')" = "$(echo "$GIT_STATIONS" | jq -S '.')" ]; then
            echo "No changes to station list"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "$MERGED" | jq '.' > data/known_stations.json
            echo "Station list updated"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
        env:
          APP_URL: ${{ secrets.APP_URL }}

      - name: Commit and push station sync
        if: steps.sync.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/known_stations.json
          git commit -m "Sync stations from Railway (pre-deploy)

          Merged stations from Railway with git to prevent data loss.

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)"
          git push

  test:
    runs-on: ubuntu-latest
    # Wait for sync job if it ran, but don't fail if it was skipped
    needs: [sync-stations]
    if: always() && (needs.sync-stations.result == 'success' || needs.sync-stations.result == 'skipped')

    steps:
      - uses: actions/checkout@v4
        with:
          # Ensure we get the latest commit (including any sync commit)
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Pull latest (in case sync committed)
        if: github.event_name == 'push'
        run: git pull --rebase origin main || true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Lint with ruff
        run: ruff check .

      - name: Run tests
        run: pytest -v
