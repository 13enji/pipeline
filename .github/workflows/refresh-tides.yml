name: Refresh Tides

on:
  schedule:
    # Run at 2am Pacific Time (10am UTC during PST, 9am UTC during PDT)
    - cron: '0 10 * * *'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # Required to push commits back to repo

jobs:
  refresh:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Refresh tide cache
        run: |
          curl -X POST "${{ secrets.APP_URL }}/refresh-tides" \
            --fail \
            --silent \
            --show-error \
            --max-time 300
        env:
          APP_URL: ${{ secrets.APP_URL }}

      - name: Sync station list from Railway
        run: |
          # Fetch current station list from Railway
          echo "Fetching stations from Railway..."
          RAILWAY_STATIONS=$(curl -s "${{ secrets.APP_URL }}/cache-stats" | jq '[.stations[] | {
            station_id,
            timezone_name,
            name,
            state,
            latitude,
            longitude
          }]' 2>/dev/null || echo "[]")

          # If fetch failed or empty, skip sync
          if [ "$RAILWAY_STATIONS" = "[]" ] || [ -z "$RAILWAY_STATIONS" ]; then
            echo "No stations from Railway or fetch failed, skipping sync"
            echo "STATIONS_CHANGED=false" >> $GITHUB_ENV
            exit 0
          fi

          echo "Railway has $(echo "$RAILWAY_STATIONS" | jq 'length') stations"

          # Load existing stations from git
          GIT_STATIONS=$(cat data/known_stations.json)
          echo "Git has $(echo "$GIT_STATIONS" | jq 'length') stations"

          # Merge: union of both lists, deduplicated by station_id
          # This ensures we never lose stations from either source
          MERGED=$(jq -s '
            (.[0] + .[1]) |
            group_by(.station_id) |
            map(.[0])
          ' <(echo "$GIT_STATIONS") <(echo "$RAILWAY_STATIONS"))

          echo "Merged total: $(echo "$MERGED" | jq 'length') stations"

          # Check if merged is different from git
          if [ "$(echo "$MERGED" | jq -S '.')" = "$(echo "$GIT_STATIONS" | jq -S '.')" ]; then
            echo "No changes to station list"
            echo "STATIONS_CHANGED=false" >> $GITHUB_ENV
          else
            echo "$MERGED" | jq '.' > data/known_stations.json
            echo "Station list updated"
            echo "STATIONS_CHANGED=true" >> $GITHUB_ENV
          fi
        env:
          APP_URL: ${{ secrets.APP_URL }}

      - name: Commit and push station list
        if: env.STATIONS_CHANGED == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/known_stations.json
          git commit -m "Sync station list from Railway

          Automatically synced by overnight refresh job.

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)"
          git push
